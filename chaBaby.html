<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chá de Bebê</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Config Tailwind (igual)
      tailwind.config = { /* ... */ };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <style>
        /* Estilos CSS (iguais) */
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color, #FFF9F5); color: var(--text-color, #333); }
        .app-section { display: none; min-height: calc(100vh - 60px); padding-bottom: 70px; }
        .app-section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        /* ... (resto dos estilos iguais) ... */
        #event-error-section { display: none; text-align: center; padding: 2rem; }
        #event-error-section.active { display: block; }
    </style>
</head>
<body class="bg-pastel-bg text-gray-800">

    <div id="loading-overlay" class="loading-overlay visible"> <div class="spinner"></div> </div>

    <div id="app" class="container mx-auto max-w-lg p-4">
         <section id="event-error-section" class="app-section p-6 text-center"> </section>
         <section id="welcome-section" class="app-section text-center p-6"> </section>
         <section id="rsvp-section" class="app-section p-6"> </section>
         <section id="gift-section" class="app-section p-6"> </section>
         <section id="location-section" class="app-section p-6 text-center"> </section>
         <section id="calendar-section" class="app-section p-6 text-center"> </section>
         <section id="thankyou-section" class="app-section p-6 text-center"> </section>
         <section id="admin-section" class="app-section p-6"> </section>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 max-w-lg mx-auto h-[60px] flex justify-around items-center" id="main-nav">
       </nav>
    <script>
        // --- Configuração do Firebase (SUBSTITUA) ---
        const firebaseConfig = {
        	apiKey: "AIzaSyB6NMSbRKIOyarr2c6oOG7CsXJzuuGQrHw", 
		authDomain: "chababy001-32f3a.firebaseapp.com", 
		projectId: "chababy001-32f3a",
        	storageBucket: "chababy001-32f3a.appspot.com", 
		messagingSenderId: "366959604506", 
		appId: "1:366959604506:web:0e46294e2c0f8da2bbb2a3"
        };

        // --- Inicializar Firebase ---
        let db, auth, googleProvider;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            googleProvider = new firebase.auth.GoogleAuthProvider();
        } catch (e) { console.error("Erro Firebase Init:", e); alert("Erro config app."); if(typeof View !== 'undefined' && View.showEventLoadError) { View.showEventLoadError('Erro Init Firebase.'); View.hideLoading(); } }

        // --- MODEL ---
        const Model = {
            // Propriedades (iguais)
            currentEventId: null, appConfig: null, giftDataCache: [], currentUser: null,
            isAdmin: false, currentRsvpData: null, currentRsvpDocId: null,
            // Funções (com log de data melhorado)
            async loadEventConfig(eventId) { /* ... igual (v11) ... */ },
            async saveEventConfig(updatedConfigData) { /* ... igual (v11) ... */ },
            async loadGifts() { /* ... igual (v11) ... */ },
            async addGift(giftDetails) { /* ... igual (v11) ... */ },
            async deleteGift(giftId) { /* ... igual (v11) ... */ },
            async findRsvpByEmail(email) { /* ... igual (v11) ... */ },
            async saveRsvp(rsvpData) { /* ... igual (v11) ... */ },
            async reserveGiftTransaction(giftId, rsvpDocId, isDrawn) { /* ... igual (v11) ... */ },
            async signInWithGoogle() { /* ... igual (v11) ... */ },
            async signOut() { /* ... igual (v11) ... */ },
            setCurrentUser(user) { /* ... igual (v11) ... */ },
            checkAdminStatus() { /* ... igual (v11) ... */ }
        };

        // --- VIEW ---
        const View = {
            elements: { /* ... referências iguais ... */ },
            // Funções (com log de data e link mapa corrigidos)
            showLoading() { /* ... igual (v11) ... */ },
            hideLoading() { /* ... igual (v11) ... */ },
            showSection(sectionId) { /* ... igual (v11) ... */ },
            showEventLoadError(message) { /* ... igual (v11) ... */ },
            showError(element, message) { /* ... igual (v11) ... */ },
            hideError(element) { /* ... igual (v11) ... */ },
            showSuccess(element, message) { /* ... igual (v11) ... */ },
            applyTheme(themeColor = 'pink') { /* ... igual (v11) ... */ },
            displayWelcomeInfo(config, eventId) { /* ... igual (v11) ... */ },
            displayEventDetails(config) { /* ... igual (v11) ... */ },
            updateAdminAuthButton(isUserAdmin, user) { /* ... igual (v11) ... */ },
            updateNavGiftButton(enabled) { /* ... igual (v11) ... */ },
            fillRsvpForm(rsvpData) { /* ... igual (v11) ... */ },
            clearRsvpForm() { /* ... igual (v11) ... */ },
            displayRsvpSuccess(name) { /* ... igual (v11) ... */ },
            displayRsvpNo(name) { /* ... igual (v11) ... */ },
            renderGiftList(gifts, onSelectCallback) { /* ... igual (v11) ... */ },
            selectGiftUI(element) { /* ... igual (v11) ... */ },
            clearGiftSelectionUI() { /* ... igual (v11) ... */ },
            displayGiftResult(message, isSuccess) { /* ... igual (v11) ... */ },
            populateAdminForm(config, eventId) { /* ... igual (v11) ... */ },
            renderAdminGiftList(gifts, deleteCallback) { /* ... igual (v11) ... */ },
            clearAddGiftForm() { /* ... igual (v11) ... */ }
        };

        // --- CONTROLLER ---
        const Controller = {
            selectedGiftId: null,

            init() { /* ... igual (v11) ... */ },

            // *** FUNÇÃO ATUALIZADA COM LOGS EXTRAS ***
            setupEventListeners() {
                console.log("Controller: Configurando listeners...");
                // Verifica se os elementos principais existem antes de adicionar listeners
                if (View.elements.mainNav) {
                    View.elements.mainNav.addEventListener('click', (e) => this.handleActionClick(e));
                    console.log("Controller: Listener adicionado a mainNav.");
                } else {
                    console.error("Controller: Elemento mainNav não encontrado!");
                }

                // Listener no body para ações gerais (delegação)
                document.body.addEventListener('click', (e) => this.handleActionClick(e));
                console.log("Controller: Listener adicionado ao body.");

                // Listeners de formulário
                if (View.elements.rsvpForm) {
                    View.elements.rsvpForm.addEventListener('submit', (e) => this.handleRsvpSubmit(e));
                    console.log("Controller: Listener adicionado a rsvpForm.");
                } else { console.warn("Controller: Elemento rsvpForm não encontrado.")};

                if (View.elements.guestEmailInput) {
                    View.elements.guestEmailInput.addEventListener('blur', (e) => this.handleRsvpEmailBlur(e));
                     console.log("Controller: Listener adicionado a guestEmailInput.");
                } else { console.warn("Controller: Elemento guestEmailInput não encontrado.")};

                if (View.elements.adminEventForm) {
                    View.elements.adminEventForm.addEventListener('submit', (e) => this.handleAdminSaveConfig(e));
                     console.log("Controller: Listener adicionado a adminEventForm.");
                } else { console.warn("Controller: Elemento adminEventForm não encontrado.")};

                if (View.elements.addGiftForm) {
                    View.elements.addGiftForm.addEventListener('submit', (e) => this.handleAdminAddGift(e));
                     console.log("Controller: Listener adicionado a addGiftForm.");
                } else { console.warn("Controller: Elemento addGiftForm não encontrado.")};

                 // Listener Delegado para botões delete na lista admin
                 if (View.elements.adminGiftListDiv) {
                    View.elements.adminGiftListDiv.addEventListener('click', (e) => {
                        const button = e.target.closest('button[data-action="delete-gift"]');
                        if (button) {
                            const giftId = button.dataset.giftId;
                            const reservedCount = parseInt(button.dataset.reservedCount, 10);
                            this.handleAdminDeleteGift(giftId, reservedCount);
                        }
                    });
                    console.log("Controller: Listener adicionado a adminGiftListDiv.");
                 } else { console.warn("Controller: Elemento adminGiftListDiv não encontrado.")};

                 // Listener Delegado para itens na lista de presentes convidado
                 if (View.elements.giftListContainer) {
                     View.elements.giftListContainer.addEventListener('click', (e) => {
                         const giftItem = e.target.closest('.gift-item');
                         if (giftItem && giftItem.dataset.giftId) {
                             this.handleGiftSelect(giftItem.dataset.giftId, giftItem);
                         }
                     });
                     console.log("Controller: Listener adicionado a giftListContainer.");
                 } else { console.warn("Controller: Elemento giftListContainer não encontrado.")};
            },

            // *** FUNÇÃO ATUALIZADA COM LOG EXTRA ***
            handleActionClick(event) {
                 const button = event.target.closest('[data-action]');
                 if (!button) return; // Sai se não clicou em algo com data-action
                 const action = button.dataset.action;
                 console.log(`Controller: handleActionClick disparado para ação: ${action}`, event.target); // Log extra

                 if (!Model.appConfig && action !== 'admin-auth' && action !== 'show-welcome') {
                     alert("Aguarde o carregamento dos dados do evento.");
                     return;
                 }

                 try {
                     switch (action) {
                         case 'show-welcome': View.showSection('welcome-section'); break;
                         case 'show-rsvp': View.showSection('rsvp-section'); break;
                         case 'show-gift': View.showSection('gift-section'); break;
                         case 'show-location': View.showSection('location-section'); break;
                         case 'show-calendar': View.showSection('calendar-section'); break;
                         case 'admin-auth': this.handleAdminAuth(); break;
                         case 'confirm-manual-gift': this.handleConfirmManualGift(); break;
                         case 'draw-gift': this.handleDrawGift(); break;
                         default: console.warn(`Controller: Ação desconhecida ou não tratada: ${action}`);
                     }
                 } catch (error) {
                      console.error(`Controller: Erro ao executar ação '${action}':`, error);
                      // Tenta mostrar um erro genérico na UI se possível
                      if (View.elements.rsvpError) View.showError(View.elements.rsvpError, `Ocorreu um erro inesperado. Tente novamente.`);
                 }
             },

            setupAuthListener() { /* ... igual (v11) ... */ },
            async handleRsvpSubmit(event) { /* ... igual (v11 - sem findRsvpByEmail) ... */ },
            async handleRsvpEmailBlur(event) { /* ... igual (v11 - vazio) ... */ },
            handleGiftSelect(giftId, element) { /* ... igual (v11) ... */ },
            async handleConfirmManualGift() { /* ... igual (v11) ... */ },
            async handleDrawGift() { /* ... igual (v11) ... */ },
            async handleAdminAuth() { /* ... igual (v11) ... */ },
            async handleAdminSaveConfig(event) { /* ... igual (v11) ... */ },
            async handleAdminAddGift(event) { /* ... igual (v11) ... */ },
            async handleAdminDeleteGift(giftId, reservedCount) { /* ... igual (v11) ... */ },
            setupUIWithConfig() { /* ... igual (v11) ... */ }
        };

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => { /* ... igual (v11) ... */ });

    </script>

</body>
</html>




